
Step 1: Setup Vault and deploy a HA Vault Cluster within Kubernetes.  This demo used a codelab for Google Kubernetes Engine (GKE)
: https://codelabs.developers.google.com/codelabs/vault-on-gke/index.html?index=..%2F..cloud#0.  The demo can also be setup
using HashiCorp Vaults learning lab: https://learn.hashicorp.com/vault/getting-started/install

Step 2: This demo will create 4 sample vault policies using the following code.

1. admin:

$ vault policy write admin -<<EOF
#HashiCorp guidance states the admin is focused on configuring and 
#maintaining the health of the clusters and providing support.
#They must be able to mount and manage auth back-ends (auth methods
#perform authentication and assign identity and a set of policies)
#mount and manage secret back-ends, create and manage ACL policies
#and read system heath checks:
path "auth/*"
{
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}

# List, create, update, and delete auth backends
path "sys/auth/*"
{
  capabilities = ["create", "read", "update", "delete", "sudo"]
}

# To list policies - Step 3
path "sys/policy"
{
  capabilities = ["read"]
}

# Create and manage ACL policies broadly across Vault
path "sys/policy/*"
{
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}

# List, create, update, and delete key/value secrets
path "secret/*"
{
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}

# Manage and manage secret backends broadly across Vault.
path "sys/mounts/*"
{
  capabilities = ["create", "read", "update", "delete", "list", "sudo"]
}

# Read health checks
path "sys/health"
{
  capabilities = ["read", "sudo"]
}

path "sys/capabilities"
{
  capabilities = ["create", "update"]
}

path "sys/capabilities-self"
{
  capabilities = ["create", "update"]
}
EOF

2. audit user

Before we create an audit user policy, we need to enable auditing.

$ vault audit enable file file_path=/tmp/my-file.txt

Listing audit devices will confirm they are present

$ vault audit list

$ vault policy write audit-user -<<EOF
#Auditors should have read access to the audit logs.
#Within an Entrprise, auditors should not have greater than read access
#to paths used by the admin or other users.  This is to reduce
#any risks of making changes by mistake.
path "var/log"
{
  capabilities = ["read"]
}

path "auth/*"
{
  capabilities = ["read"]
}
path "sys/auth/*"
{
  capabilities = ["read"]
}

# To list policies - Step 3
path "sys/policy"
{
  capabilities = ["read"]
}
path "sys/policy/*"
{
  capabilities = ["read"]
}
path "secret/*"
{
  capabilities = ["read"]
}
path "sys/mounts/*"
{
  capabilities = ["read"]
}
path "sys/health"
{
  capabilities = ["read"]
}
path "sys/capabilities"
{
  capabilities = ["read"]
}
path "sys/capabilities-self"
{
  capabilities = ["read"]
}
EOF

3. Business User With Access to a Business Specific Path.

$ vault policy write bus-group -<<EOF
#this policy will allow the user to access the bus path "secret/data/team/bus"
path "secret/data/team/bus"
{ capabilities = ["create", "read", "update", "delete"]
}
EOF

4. Engineering User With Access to an Engineering Specific Path.

$ vault policy write eng-group -<<EOF
#this policy will allow the user to access the eng path "secret/data/team/eng"
path "secret/data/team/eng"
{ capabilities = ["create", "read", "update", "delete"]
}
EOF


Step 3: confirm the policies are there and view their contents.

$ vault policy list

$ vault policy read admin
$ vault policy read audit-user
$ vault policy read bus-group
$ vault policy read eng-group 

